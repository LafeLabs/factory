<script src = "https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.js"></script>

<table id = "linktable">

    <tr>
        <td class = "button" id = "publish">PUBLISH</td>
        <td>
            <a href = "../combiner/"><img style = "width:100px" src = "../factory_symbols/combiner.svg"></a>
        </td>
        <td>
            <a href = "memefeed.php"><img style = "width:80px" src = "../factory_symbols/feed.svg"></a>
        </td>
        <td>
            <a href = "editor.php"><img style = "width:80px" src = "../factory_symbols/editor.svg"></a>
        </td>
        <td>
            <a href = "../"><img style = "width:80px" src = "../factory_symbols/factory.svg"></a>
        </td>
    </tr>
</table>


    
<div id = "imagebox">
<img id = "image0"/>
</div>

<div id = "scale">SCALE</div>
<div id = "rotate">ROTATE</div>

<script>

imageslist = JSON.parse(document.getElementById("imagesdatadiv").innerHTML);

document.getElementById("image0").style.height = (innerHeight - 200).toString() + "px";

document.getElementById("image0").src = imageslist[0];



document.getElementById("image0").onload = function(){
    if(this.width > innerWidth){
        var aspectRatio = this.width/this.height; 
        this.width = innerWidth;
        this.style.height = (this.width/aspectRatio).toString() + "px";
        imageWidth = innerWidth;
    }
    else{
        imageWidth = this.width;
    }

}


imageIndex= 0;
topimages = [];
for(var index = 1;index < imageslist.length;index++){
    var newimg = document.createElement("IMG");
    newimg.src = imageslist[index];
    newimg.className = "topimage";
    document.getElementById("imagebox").appendChild(newimg);
    topimages.push(newimg);
    newimg.style.width = "80px";
    newimg.style.top = "80px";
    newimg.style.left = (85*index).toString() + "px";
    newimg.style.transform = "rotate(0deg)";
}


mc = new Hammer(document.getElementById("image0"));
mc.get('pan').set({ direction: Hammer.DIRECTION_ALL });
mc.on("panleft panright panup pandown tap press", function(ev) {
    topimages[imageIndex].style.left = (ev.deltaX + 0.5*imageWidth).toString() + "px";
    topimages[imageIndex].style.top = (ev.deltaY + 0.3*imageWidth).toString() + "px";
});    

/*mcback = new Hammer(document.getElementById("imagebox"));
mcback.get('pan').set({ direction: Hammer.DIRECTION_ALL });
mcback.on("panleft panright panup pandown tap press", function(ev) {
    topimages[imageIndex].style.left = (ev.deltaX + 0.5*imageWidth).toString() + "px";
    topimages[imageIndex].style.top = (ev.deltaY + 0.3*imageWidth).toString() + "px";
});    */

for(var index = 0;index < topimages.length;index++){
    topimages[index].id = "i" + index.toString();
    topimages[index].onclick = function(){
        topimages[imageIndex].style.border = "none";
        imageIndex = parseInt(this.id.substring(1));
        topimages[imageIndex].style.border = "solid";
    }
}

topimages[imageIndex].style.border = "solid";


//pans = document.getElementById("pantable").getElementsByTagName("TD");


mc1 = new Hammer(document.getElementById("scale"));
mc1.get('pan').set({ direction: Hammer.DIRECTION_ALL });
mc1.on("panleft panright panup pandown tap press", function(ev) {
    topimages[imageIndex].style.width = (ev.deltaX + 0.2*imageWidth).toString() + "px";
});

mc2 = new Hammer(document.getElementById("rotate"));
mc2.get('pan').set({ direction: Hammer.DIRECTION_ALL });
mc2.on("panleft panright panup pandown tap press", function(ev) {
    topimages[imageIndex].style.transform = "rotate(" + (ev.deltaX*Math.PI/10).toString() + "deg)";
});

document.getElementById("publish").onclick = function(){
    outjson = {};
    outjson.imgurl = document.getElementById("image0").src;
    outjson.topimages = [];
    for(var index = 0;index < topimages.length;index++){
        var imgjson = {};
        imgjson.url = topimages[index].src;
        imgjson.xoverw = parseFloat(topimages[index].style.left)/imageWidth;
        imgjson.yoverw = parseFloat(topimages[index].style.top)/imageWidth;
        imgjson.woverw = parseFloat(topimages[index].style.width)/imageWidth;
        imgjson.angle = parseFloat(topimages[index].style.transform.substr(7));
        outjson.topimages.push(imgjson);
    }
    
    timestamp = Math.round((new Date().getTime())/1000);
    data = encodeURIComponent(JSON.stringify(outjson,null,"    "));

    var httpc = new XMLHttpRequest();
    var url = "filesaver.php";        
    httpc.open("POST", url, true);
    httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");
    httpc.send("data=" + data + "&filename=" + "memes/meme" + timestamp + ".txt");//send text to filesaver.php
}

</script>
<style>
.topimage{
    position:absolute;
    z-index:1;
}
#imagebox{
    position:absolute;
    left:0px;
    top:0px;
    right:0px;
    bottom:0px;
    border:solid;
    overflow:hidden;
}
#image0{
    position:absolute;
    left:0px;
    top:0px;
    display:block;
}
#linktable{
    z-index:2;
    position:absolute;
    right:0px;
    bottom:0px;
}
#rotate{
    position:absolute;
    right:50%;
    height:100px;
    bottom:0px;
    left:0px;
    border:solid;
}
#scale{
    position:absolute;
    right:50%;
    height:100px;
    bottom:100px;
    left:0px;
    border:solid;
}

.button{
    cursor:pointer;
    border:solid;
    border-radius:5px;
}
.button:active{
    background-color:yellow;
}
</style>